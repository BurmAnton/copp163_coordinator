{% extends "layout.html" %}
{% load static %}

{% block title %}Контакты партнёров{% endblock %}
{% block style %}
    <link href="{% static 'users/css/contacts_list.css' %}" rel="stylesheet">
{% endblock %}
{% block script %}
    <script src="{% static 'users/js/contacts_list.js' %}" rel="stylesheet"></script>
{% endblock %}

{% block body %}
    <!--Modals--> 
    <div class="modal fade" id="AddContactModal" tabindex="-1" aria-labelledby="AddContactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="AddContactModalLabel">Добавление контакта</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'contacts_list' %}"  method="post">
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="input" class="form-control" name="last_name" id="LastName" placeholder="Фамилия">
                    </div>
                    <div class="input-group mb-3">
                        <input type="input" class="form-control" name="first_name" id="Name" placeholder="Имя" required>
                    </div>
                    <div class="input-group mb-3">
                        <input type="input" class="form-control" name="middle_name" id="MiddleName" placeholder="Отчество">
                    </div>
                    <div class="input-group mb-3">
                        <input type="email" class="form-control" name="email" placeholder="Email" aria-label="Email" aria-describedby="at">
                        <span class="input-group-text" id="at">@</span>
                    </div>
                    <div class="input-group mb-3">
                        <input type="phone2numeric" class="form-control" name="phone" id="Phone" placeholder="Номер телефона" maxlength="18"  required>
                    </div>
                    <div class="form mb-3">
                        <select class="selectpicker" title="Выберите организацию" data-width="100%" data-live-search="true" name="organization" id="Organization" required>
                            {% for organization in organizations %}
                                <option class="organization" value="{{organization.id}}">{{organization}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="input-group mb-3">
                        <input type="input" class="form-control" name="job_title" id="JobTitle" placeholder="Должность">
                    </div>
                    <div class="form mb-3">
                        <select class="selectpicker" title="Выберите проекты" multiple data-width="100%" data-live-search="true" name="project" id="Project" required>
                            {% for project in projects %}
                                <option class="project" value="{{project.id}}">{{project}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="commentary" class="form-label">Комментарий</label>
                        <textarea class="form-control" name='commentary' id="commentary" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-dark" name="add_contact">Добавить</button>
                    
                </div>
            </form>

        </div>
        </div>
    </div>
    <div class="modal fade" id="OrgModal" tabindex="-1" aria-labelledby="OrgModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="OrgModalLabel">Добавление организации</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'add_organization' %}" method="post" name="add_organization">
                    <div class="modal-body">
                        <div class="input-group mb-3">
                            <input type="input" class="form-control" name="name" id="OrgName" placeholder="Название организации">
                        </div>
                        <div class="input-group mb-3">
                            <input type="input" class="form-control" name="organization_inn" id="OrganizationINN" placeholder="ИНН организации">
                        </div>
                        <div class="form mb-3">
                            <select class="selectpicker" title="Выберите тип организации" data-width="100%" data-live-search="true" name="organization_type" id="OrganizationType" required>
                                <option class="organization_type" value="ECSPO">ЦО СПО</option>
                                <option class="organization_type" value="ECVO">ЦО ВО</option>
                                <option class="organization_type" value="ECP">ЦО частные</option>
                                <option class="organization_type" value="GOV">Гос. орган</option>
                                <option class="organization_type" value="OTH">Другие</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-dark">Добавить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="ImportContactsModal" tabindex="-1" aria-labelledby="ImportContactsLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ImportContactsLabel">Импорт контактов</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form enctype="multipart/form-data" action="{% url 'contacts_list' %}" method="post">
                    <div class="modal-body">
                        <div class="mb-3 import-field">
                            {{ form }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="submit">
                            <input type="submit" value="Загрузить данные" class="btn btn-dark" name="import_contacts">   
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="messages-board">

        {% if message == 'IndexError' %}
            <div class="alert alert-danger" role="alert">
                Проблема обработки файла!
            </div> 
        {% elif message == 'EmptySheet' %}
            <div class="alert alert-danger" role="alert">
                Таблица пуста!
            </div> 
        {% elif message == 'MissingFieldsError' %}
            <div class="alert alert-danger" role="alert">
                Часть полей отсутствует:
                <ul>
                    {% for field in data.2 %}
                        <li>{{field}}</li>
                    {% endfor %}
                </ul>
            </div> 
        {% elif message == 'AddContact' %}
            <div class="alert alert-success" role="alert">
                Пользователь '{{data.last_name}} {{data.first_name}} {{data.middle_name}}' добавлен успешно!
            </div>
        {% elif message %}
            {% if data.1 != 0 %}
                <div class="alert alert-success" role="alert">
                    Контактов добавлено: {{data.1}}
                </div>
            {% endif %}
             {% if data.3 != 0 %}
                <div class="alert alert-success" role="alert">
                    Организаций добавлено: {{data.3}}
                </div>
            {% endif %}
            <!--Ошибки-->
            {% for problem in data.2 %}
                {% if problem.0 == 'ContactDublicateError' %}
                    <div class="alert alert-danger" role="alert">
                        Пользователь '{{problem.1.last_name}} {{problem.1.first_name}} {{problem.1.middle_name}} ({{problem.1.organization}})' уже существует!
                    </div> 
                {% endif %}
                {% if problem.0 == 'ProjectError' %}
                    <div class="alert alert-danger" role="alert">
                        Проекта с названием '{{problem.1}}' не найдено!
                        Пользователи с этим теруправлением не добавлены.
                    </div> 
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
    <div class="control-panel">
        <div>
            <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#AddContactModal">
                Добавить контакт
            </button>
            <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#OrgModal">
                Добавить организацию
            </button>
        </div>
        <button class="btn btn-dark import-btn" data-bs-toggle="modal" data-bs-target="#ImportContactsModal">
            <img src="{%static 'users/img/icon-xls-import.png' %}" alt="">
            Импортировать контакты
        </button>
    </div>
    <table class="contact-list table table-light table-striped table-hover">
        <thead class="thead-dark sticky-top">
            <th>Фамилия</th>
            <th>Имя</th>
            <th>Отчество</th>
            <th>Организация</th>
            <th>Должность</th>
            <th>Проекты</th>
            <th>Emails</th>
            <th>Телефоны</th>
        </thead>
        {% for contact in contacts %}
            <tr>
                <td>{{contact.last_name}}</td> 
                <td>{{contact.first_name}}</td>
                <td>{{contact.middle_name}}</td>
                <td>{{contact.organization}}</td>
                <td>{{contact.job_title}}</td>
                <td>
                    {% for project in contact.projects.all %}
                        <div style="white-space: nowrap">{{project.project_name}}</div>
                    {% endfor %}
                </td>
                <td>
                    {% for email in contact.emails.all %}
                        <div>{{email.email}}</div>
                    {% endfor %}
                </td>
                <td >
                    {% for phone in contact.phones.all %}
                        <div style="white-space: nowrap">{{phone.phone}}</div>
                    {% endfor %}
                </td>
            </tr>
        {% endfor %}
        <thead class="thead-dark">
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th>Контактов: {{contacts_count}}</th>
        </thead>
    </table>
{% endblock %}
