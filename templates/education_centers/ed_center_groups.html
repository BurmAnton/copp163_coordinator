{% extends "layout.html" %}
{% load static %}
{% load ed_centers_extras %}

{% block title %}Личный кабинет ЦО{% endblock %}
{% block style %}
        <link href="{% static 'education_centers/css/ed_center_groups.css' %}" rel="stylesheet">
{% endblock %}
{% block script %}
    <script src="{% static 'education_centers/js/ed_center_groups.js' %}" rel="stylesheet"></script>
{% endblock %}

{% block body %}
<div class="modal fade bank-details-modal" id="HeadModal" tabindex="-1" aria-labelledby="HeadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="HeadModalLabel">Руководитель</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'ed_center_groups' ed_center.id %}" method="post">
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="input" class="form-control" name="last_name" placeholder="Фамииля" value="{{ed_center.head.last_name}}" required>
                        <label for="last_name">Фамилия</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="input" class="form-control" name="first_name" placeholder="Имя" value="{{ed_center.head.first_name}}" required>
                        <label for="last_name">Имя</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="input" class="form-control" name="middle_name" placeholder="Отчество" value="{{ed_center.head.middle_name}}">
                        <label for="last_name">Отчество</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="input" class="form-control" name="position" placeholder="Должность" value="{{ed_center.head.position}}" required>
                        <label for="last_name">Должность</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="input" class="form-control" name="last_name_r" placeholder="Фамииля (родительный падеж)" value="{{ed_center.head.last_name_r}}" required>
                        <label for="last_name">Фамилия (родительный падеж)</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="input" class="form-control" name="first_name_r" placeholder="Имя (родительный падеж)" value="{{ed_center.head.first_name_r}}" required>
                        <label for="last_name">Имя (родительный падеж)</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="input" class="form-control" name="middle_name_r" placeholder="Отчество (родительный падеж)" value="{{ed_center.head.middle_name_r}}">
                        <label for="last_name">Отчество (родительный падеж)</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="input" class="form-control" name="position_r" placeholder="Должность (родительный падеж)" value="{{ed_center.head.position_r}}" required>
                        <label for="last_name">Должность (родительный падеж)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-grid gap-2">
                        <input type="submit" class="btn btn-primary" name="head" value="Сохранить">
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade bank-details-modal" id="BankDetailsModal" tabindex="-1" aria-labelledby="BankDetailsLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="BankDetailsLabel">Платёжная информация</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'ed_center_groups' ed_center.id %}" method="post">
                <div class="modal-body">
                    <div class="bank-details-1">
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="inn" placeholder="ИНН" value="{{ed_center.bank_details.inn}}" required>
                            <label for="inn">ИНН</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="kpp" placeholder="КПП" value="{{ed_center.bank_details.kpp}}" required>
                            <label for="kpp">КПП</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="oktmo" placeholder="ОКТМО" value="{{ed_center.bank_details.oktmo}}" required>
                            <label for="oktmo">ОКТМО</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="ogrn" placeholder="ОГРН" value="{{ed_center.bank_details.ogrn}}" required>
                            <label for="ogrn">ОГРН</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="okpo" placeholder="ОКПО" value="{{ed_center.bank_details.okpo}}" required>
                            <label for="okpo">ОКПО</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="okved" placeholder="ОКВЭД" value="{{ed_center.bank_details.okved}}" required>
                            <label for="okved">ОКВЭД</label>
                        </div>
                    </div>
                    <div class="bank-details-2">
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="bank" placeholder="Банк" value="{{ed_center.bank_details.bank}}" required>
                            <label for="bank">Банк</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="biс" placeholder="БИК" value="{{ed_center.bank_details.biс}}" required>
                            <label for="biс">БИК</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="account_number" placeholder="р/с" value="{{ed_center.bank_details.account_number}}" required>
                            <label for="account_number">р/с</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="corr_account" placeholder="К/сч" value="{{ed_center.bank_details.corr_account}}" required>
                            <label for="corr_account">К/сч</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="accountant" placeholder="Главный бухгалтер" value="{{ed_center.bank_details.accountant}}" required>
                            <label for="accountant">Главный бухгалтер</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="phone" placeholder="Телефон(-ы)" value="{{ed_center.bank_details.phone}}" required>
                            <label for="phone">Телефон(-ы)</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="email" placeholder="Email" value="{{ed_center.bank_details.email}}" required>
                            <label for="email">Email</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="legal_address" placeholder="Юридический адрес" value="{{ed_center.bank_details.legal_address}}" required>
                            <label for="legal_address">Юридический адрес</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="input" class="form-control" name="mail_address" placeholder="Почтовый адрес" value="{{ed_center.bank_details.mail_address}}" required>
                            <label for="mail_address">Почтовый адрес</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-grid gap-2">
                        <input type="submit" class="btn btn-primary" name="bank-details" value="Сохранить">
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% for group in groups %}
    <div class="modal fade group-modal" id="GroupModal{{group.id}}" tabindex="-1" aria-labelledby="GroupModal{{group.id}}Label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="GroupModal{{group.id}}Label">Группа №{{group.name}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="card-text"><b>Программа:</b> {{group.education_program}}</p>
                    <p class="card-text">
                        <b>Начало обучения:</b> {{group.start_date}} <br>
                        <b>Окончание обучения:</b> {{group.end_date}}
                    </p>
                    <p class="card-text"><b>Статус:</b> {{group.get_group_status_display}}</p>
                    <p class="card-text list-title"><b>Список обучающихся:</b></p>
                    <ul class="list-group list-group-flush">
                        {% for student in group.students.all %}
                            <li class="list-group-item">{{student}}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endfor %}
{% for contract in contracts %}
    {% for assigment in contract.children_docs.all %}
        {% for group in assigment.groups.all|get_groups_wo_act %}
            {% if forloop.first %}
                <div class="modal fade act-modal" id="ActModal{{assigment.id}}" tabindex="-1" aria-labelledby="ActModal{{assigment.id}}Label" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="ActModal{{assigment.id}}Label">Формирование акта</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form action="{% url 'ed_center_groups' ed_center.id %}" method="post">
                                <div class="modal-body">
                                    <input style="display: none;" type="number" name="doc_parent" value={{assigment.id}}>
                                    <div class="form mb-3">
                                        <select class="selectpicker w-100 act_groups" title="Выберите группы" multiple data-live-search="true" name="act_groups" required>
                                            {% for group in assigment.groups.all|get_groups_wo_act:'COMP' %}
                                                <option value="{{group.id}}">№{{group.name}} - {{group.education_program}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% for group in assigment.groups.all|get_groups_wo_act %}
                                        <div style="display: none;" class="students_list" data-group="{{group.id}}">
                                            <p>Группа №{{group}}</p>
                                            {% for student in group.students.all %}
                                                <div class="mb-3">
                                                    <label for="student_doc{{student.id}}">{{student.applicant}}</label>
                                                    <input type="input" class="form-control" name="student_doc{{student.id}}" placeholder="Документ о квалификации" required>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="modal-footer">
                                    <div class="d-grid gap-2">
                                        <input type="submit" class="btn btn-primary" name="create_act" value="Сформировать акт">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% endfor %}
{% endfor %}
    <div class="edcenter-profile">
        <div class="edcenter-name">
            <h1>{{ed_center}}</h1>
        </div>
        <div class="edcenter-bank-details">
            <h2 class="director-h2 data-bs-target" data-bs-toggle="modal" data-bs-target="#HeadModal">Руководитель</h2>
            <div class="director">
                <p><b>ФИО:</b> {{ed_center.head.get_name}}</p>
                <p><b>ФИО (род. падеж):</b> {{ ed_center.head|get_name_r }}</p>
                <p><b>Должность:</b> {{ed_center.head.position}}</p>
                <p><b>Должность (род. падеж):</b> {{ed_center.head.position_r}}</p>
            </div>
            <h2 class="bank-h2 data-bs-target" data-bs-toggle="modal" data-bs-target="#BankDetailsModal">Платёжная информация</h2>
            <div class="inn">
                <p><b>ИНН/КПП:</b> {{ed_center.bank_details.inn}}/{{ed_center.bank_details.kpp}}</p>
                <p><b>ОКТМО:</b> {{ed_center.bank_details.oktmo}}</p>
                <p><b>ОГРН:</b> {{ed_center.bank_details.ogrn}}</p>
                <p><b>ОКПО/ОКВЭД:</b> {{ed_center.bank_details.okpo}}/{{ed_center.bank_details.okved}}</p>
            </div>
            <div class="bank">
                <p><b>{{ed_center.bank_details.bank}}</b></p>
                <p><b>БИК:</b> {{ed_center.bank_details.biс}}</p>
                <p><b>р/с:</b> {{ed_center.bank_details.account_number}}</p>
                <p><b>К/сч:</b> {{ed_center.bank_details.corr_account}}</p>
            </div>
            <div class="contacts">
                <p><b>Главный бухгалтер:</b> {{ed_center.bank_details.accountant}}</p>
                <p><b>Телефон(-ы):</b> {{ed_center.bank_details.phone}}</p>
                <p><b>Email:</b> {{ed_center.bank_details.email}}</p>
            </div>
            <div class="address">
                <p><b>Юридический адрес:</b> {{ed_center.bank_details.legal_address}}</p>
                <p><b>Почтовый адрес:</b> {{ed_center.bank_details.mail_address}}</p>
            </div>
        </div>
    </div>
    <div class="modal fade AddAssModal" id="AddAssModal" tabindex="-1" aria-labelledby="AddAssModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="AddAssModalLabel">Добавить задание</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'ed_center_groups' ed_center.id %}" method="post">
                    <div class="modal-body">
                        <div class="form mb-3">
                            <select class="selectpicker w-100" title="Выберите группы" multiple data-live-search="true" name="groups" required>
                                {% for group in free_groups %}
                                    <option value="{{group.id}}">№{{group.name}} - {{group.education_program}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="d-grid gap-2">
                            <input type="submit" class="btn btn-primary" name="create_assignment" value="Сформировать задание">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="documents">
        <div class="doc-table">
            <div class="doc-table-hdr">
                <h2>Документы по группам</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#AddAssModal">Создать задание</button>
            </div>
            <table class="table">
                <tr class="sticky-top"> 
                    <th scope="col" style="max-width: 250px;">Задание на оказание услуг</th>
                    <th scope="col">Учебные группы</th>
                    <th scope="col" style="max-width: 250px;">Список лиц, завершивших обучение</th>
                    <th scope="col" style="max-width: 250px;">Акт выполненных работ</th>
                    <th scope="col" style="max-width: 250px;">Счет на оплату</th>
                </tr>
                {% for contract in contracts %}
                    {% for assigment in contract.children_docs.all %}
                        {% for act in assigment.children_docs.all %}
                            {% for group in act.groups.all %}
                                {% if forloop.parentloop.parentloop.counter|divisibleby:2 %}
                                    <tr>
                                {% else %}
                                    <tr class="colored-row">
                                {% endif %}
                                    {% if forloop.first and forloop.parentloop.first %}
                                        <td scope="row" rowspan="{{ assigment.groups.all|length }}">
                                            <p><a href="{{ assigment.doc_file.url }}">Задание №{{ assigment.register_number }} от {{ assigment.creation_date|date:"d.m.y" }}</a></p>
                                            <p><b>Статус:</b> {{ assigment.get_doc_stage_display }}</p>
                                        </td>
                                    {% endif %}
                                    <td scope="row" style="max-width: 300px;">
                                        <p><b data-bs-toggle="modal" data-bs-target="#GroupModal{{group.id}}">Группа №{{ group.name }}</b> ({{ group.start_date|date:"d.m" }}-{{ group.end_date|date:"d.m" }}) - {{ group.education_program }}</p>
                                        <p><b>Статус группы:</b> {{ group.get_group_status_display }}</p>
                                    </td>
                                    <td scope="row">
                                        {% if group|get_list == None %}
                                            <p>Cписок отсутствует</p>
                                        {% else %} 
                                            {% with group|get_list as students_list %}
                                                <p><a href="{{ students_list.doc_file.url }}">Список лиц, завершивших обучение</a></p>
                                            {% endwith %}
                                            <p><b>Статус:</b> {{ act.get_doc_stage_display }}</p>
                                        {% endif %}
                                    </td>
                                    {% if forloop.first %}
                                        <td scope="row" rowspan="{{ act.groups.all|length }}">
                                            <p><a href="{{act.doc_file.url}}">Акт №{{ act.register_number }} от {{ act.creation_date|date:"d.m.y" }} ({{act.doc_type}})</a></p>
                                            <p><b>Статус:</b> {{ act.get_doc_stage_display }}</p>
                                        </td>
                                        <td scope="row" rowspan="{{ act.groups.all|length }}">
                                            {% if act|get_bill != None %}
                                                {% with act|get_bill as bill %}
                                                    <p><a href="{{ bill.doc_file.url }}" target="_blank">Счёт на оплату</a></p>
                                                    <p><b>Статус:</b> {{ act.get_doc_stage_display }}</p>
                                                {% endwith %}
                                            {% elif act.doc_stage == 'SGNDAP' %}
                                                <form action="{% url 'ed_center_groups' ed_center.id %}" method="post" enctype="multipart/form-data">
                                                    {% csrf_token %}
                                                    <div class="form mb-3">
                                                        <input style="display:none;" type="input" class="form-control" name="act_id"  value={{act.id}} required>
                                                    </div>
                                                    <p>{{ form.non_field_errors }}</p>
                                                    <p>{{ form.import_file.label_tag }} {{ form.import_file.help_text }}</p>
                                                    <p>
                                                        {{ form.import_file.errors }}
                                                        {{ form.import_file }}
                                                    </p>
                                                    <input style="width: 250px;" type="submit" class="btn btn-primary" name="create_bill" value="Загрузить счёт">
                                                </form>
                                            {% else %}
                                                <p>Счёт отсутствует</p>
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        {% endfor %}
                        {% for group in assigment.groups.all|get_groups_wo_act %}
                            {% if group|is_group_wo_act %}
                                {% if forloop.parentloop.counter|divisibleby:2 %}
                                    <tr>
                                {% else %}
                                    <tr class="colored-row">
                                {% endif %}
                                    {% if forloop.first and assigment.children_docs.all.count == 0 %}
                                        <td scope="row" rowspan="{{ assigment.groups.all|length }}">
                                            <p><a href="{{ assigment.doc_file.url }}">Задание №{{ assigment.register_number }} от {{ assigment.creation_date|date:"d.m.y" }}</a></p>
                                            <p><b>Статус:</b> {{ assigment.get_doc_stage_display }}</p>
                                        </td>
                                    {% endif %}
                                    <td scope="row" style="max-width: 300px;">
                                        <p><b data-bs-toggle="modal" data-bs-target="#GroupModal{{group.id}}">Группа №{{ group.name }}</b> ({{ group.start_date|date:"d.m" }}-{{ group.end_date|date:"d.m" }}) - {{ group.education_program }}</p>
                                        <p><b>Статус группы:</b> {{ group.get_group_status_display }}</p>
                                    </td>
                                    <td scope="row">Список отсутствует</td>
                                    {% if forloop.first %}
                                        <td scope="row" rowspan="{{ assigment.groups.all|get_groups_wo_act|length }}">
                                            {% if assigment.doc_stage == 'SGNDAP' %}
                                                <p class="data-bs-target" data-bs-toggle="modal" data-bs-target="#ActModal{{assigment.id}}">Сформировать акт</p>
                                            {% else %}
                                                <p>Акт отсутствует</p>
                                            {% endif %}
                                        </td>
                                        <td scope="row" rowspan="{{ assigment.groups.all|get_groups_wo_act|length }}"><p>Счёт отсутствует</p></td>
                                    {% endif %}
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
            </table>    
        </div>
    </div>
{% endblock %}
